{% extends "_base.html" %}
{% block content %}
  <h1 class="text-2xl font-semibold mb-4">Items</h1>
  <div class="mb-4 flex justify-end gap-2">
    <a href="{% url 'item_create' %}" class="btn-primary">Add Item</a>
    <a href="{% url 'items_bulk_upload' %}" class="btn-secondary">Bulk Upload</a>
  </div>
  <form id="filters" class="mb-4" hx-indicator="#htmx-spinner" method="get">
    <fieldset class="grid gap-4 grid-cols-5 max-md:grid-cols-2 max-sm:grid-cols-1">
      <legend class="sr-only">Filter Items</legend>
      <div class="flex flex-col gap-1">
        <label for="filter-q" class="text-sm font-medium">Search</label>
        <input
          id="filter-q"
          type="text"
          name="q"
          placeholder="Search items..."
          class="form-control w-full"
          value="{{ q }}"
          hx-get="{% url 'items_table' %}"
          hx-target="#items_table"
          hx-trigger="keyup changed delay:300ms"
          hx-include="#filters"
          hx-indicator="#htmx-spinner"
        />
      </div>
      <div class="flex flex-col gap-1">
        <label for="filter-active" class="text-sm font-medium">Status</label>
        <input
          id="filter-active"
          type="text"
          name="active"
          list="item-active"
          class="form-control w-full"
          value="{{ active }}"
          hx-get="{% url 'items_table' %}"
          hx-target="#items_table"
          hx-trigger="change"
          hx-include="#filters"
          hx-indicator="#htmx-spinner"
        />
        <datalist id="item-active">
          <option value="" label="All"></option>
          <option value="1" label="Active"></option>
          <option value="0" label="Inactive"></option>
        </datalist>
      </div>
      <div class="flex flex-col gap-1">
        <label for="filter-category" class="text-sm font-medium">Category</label>
        <input
          id="filter-category"
          type="text"
          name="category"
          list="item-category"
          class="form-control w-full"
          value="{{ category }}"
          hx-get="{% url 'items_table' %}"
          hx-target="#items_table"
          hx-trigger="change"
          hx-include="#filters"
          hx-indicator="#htmx-spinner"
        />
        <datalist id="item-category">
          <option value="" label="All"></option>
          {% for c in categories %}
          <option value="{{ c }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="flex flex-col gap-1">
        <label for="filter-subcategory" class="text-sm font-medium">Subcategory</label>
        <input
          id="filter-subcategory"
          type="text"
          name="subcategory"
          list="item-subcategory"
          class="form-control w-full"
          value="{{ subcategory }}"
          hx-get="{% url 'items_table' %}"
          hx-target="#items_table"
          hx-trigger="change"
          hx-include="#filters"
          hx-indicator="#htmx-spinner"
        />
        <datalist id="item-subcategory">
          <option value="" label="All"></option>
          {% for sc in subcategories %}
          <option value="{{ sc }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="flex flex-col gap-1">
        <label class="text-sm font-medium" for="export-btn">&nbsp;</label>
        <button id="export-btn" type="submit" formaction="{% url 'items_export' %}" formmethod="get" class="btn-secondary w-full">Export</button>
      </div>
    </fieldset>
    <input type="hidden" name="sort" value="{{ sort|default:'name' }}">
    <input type="hidden" name="direction" value="{{ direction|default:'asc' }}">
    <noscript>
      <div class="mt-2">
        <button type="submit" class="btn-primary">Apply</button>
      </div>
    </noscript>
  </form>
  {{ categories_map|json_script:"categories-data" }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const categories = JSON.parse(
        document.getElementById('categories-data').textContent
      );
      const categoryInput = document.getElementById('filter-category');
      const subInput = document.getElementById('filter-subcategory');
      const subDatalist = document.getElementById('item-subcategory');

      function refreshSubcategories(selected) {
        const cat = categoryInput.value;
        const options = categories[cat] || [];
        subDatalist.innerHTML = '<option value="" label="All"></option>';
        options.forEach(function (opt) {
          const o = document.createElement('option');
          o.value = opt.name;
          subDatalist.appendChild(o);
        });
        if (
          selected &&
          options.some(function (o) {
            return o.name === selected;
          })
        ) {
          subInput.value = selected;
        } else {
          subInput.value = '';
        }
      }

      const initialSub = subInput.value;
      refreshSubcategories(initialSub);
      categoryInput.addEventListener('change', function () {
        refreshSubcategories();
      });
    });
  </script>
  <div id="items_table"
       hx-get="{% url 'items_table' %}"
       hx-trigger="load"
       hx-include="#filters"
       hx-indicator="#htmx-spinner">
    {{ items_table|safe }}
  </div>
{% endblock %}

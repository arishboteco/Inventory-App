{% extends "_base.html" %}
{% load static %}
{% block content %}
  <h1 class="text-2xl font-semibold mb-4">Stock Movements</h1>
  <form method="get" id="section-form" class="mb-4">
    {% for key, label in sections.items %}
        <label class="mr-4">
          <input type="radio" name="section" value="{{ key }}" class="form-radio" {% if key == active_section %}checked{% endif %} onchange="document.getElementById('section-form').submit();"> {{ label }}
        </label>
      {% endfor %}
  </form>
  {% if messages %}
    {% include "components/alert.html" %}
  {% endif %}
  {% if active_section == 'receive' %}
    <h2 class="text-xl font-semibold mb-2">Goods Received</h2>
    <form method="post" class="mb-4">
      {% csrf_token %}
      {% if receive_form.non_field_errors %}
      <ul class="text-red-600 dark:text-red-400 list-disc pl-5">
        {% for error in receive_form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% for field in receive_form %}
        {% include "components/form_field.html" with field=field %}
      {% endfor %}
      <button type="submit" name="submit_receive" class="btn-primary">Record</button>
    </form>
  {% elif active_section == 'adjust' %}
    <h2 class="text-xl font-semibold mb-2">Stock Adjustment</h2>
    <form method="post" class="mb-4">
      {% csrf_token %}
      {% if adjust_form.non_field_errors %}
      <ul class="text-red-600 dark:text-red-400 list-disc pl-5">
        {% for error in adjust_form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% for field in adjust_form %}
        {% include "components/form_field.html" with field=field %}
      {% endfor %}
      <button type="submit" name="submit_adjust" class="btn-primary">Record</button>
    </form>
  {% elif active_section == 'waste' %}
    <h2 class="text-xl font-semibold mb-2">Wastage/Spoilage</h2>
    <form method="post" class="mb-4">
      {% csrf_token %}
      {% if waste_form.non_field_errors %}
      <ul class="text-red-600 dark:text-red-400 list-disc pl-5">
        {% for error in waste_form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% for field in waste_form %}
        {% include "components/form_field.html" with field=field %}
      {% endfor %}
      <button type="submit" name="submit_waste" class="btn-primary">Record</button>
    </form>
  {% endif %}
  <hr class="my-4"/>
  <h2 class="text-xl font-semibold mb-2">Bulk Upload Stock Transactions</h2>
  <p class="mb-2">Download the CSV template and fill it with your stock transactions before uploading. <a href="{% static 'sample_stock_upload.csv' %}" class="text-primary underline">Download sample CSV</a></p>
  <form method="post" enctype="multipart/form-data" class="mb-4">
    {% csrf_token %}
    {% if bulk_form.non_field_errors %}
    <ul class="text-red-600 dark:text-red-400 list-disc pl-5">
      {% for error in bulk_form.non_field_errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
    {% endif %}
    {% for field in bulk_form %}
      {% include "components/form_field.html" with field=field %}
    {% endfor %}
    <button type="submit" name="bulk_upload" class="btn-primary">Upload</button>
  </form>
  {% if bulk_success_count is not None %}
    <p>{{ bulk_success_count }} transaction(s) recorded successfully.</p>
  {% endif %}
  {% if bulk_errors %}
    <ul class="text-red-700 dark:text-red-400">
      {% for e in bulk_errors %}
        <li>{{ e }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  <hr class="my-4"/>
  <h2 class="text-xl font-semibold mb-2">Recent Transactions</h2>
  <div class="max-md:overflow-x-auto">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Item</th>
          <th>Type</th>
          <th>Qty</th>
          <th>User</th>
          <th>Date</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for tx in page_obj %}
        <tr>
          <td>{{ tx.transaction_id }}</td>
          <td>{{ tx.item.name }}</td>
          <td>{{ tx.transaction_type }}</td>
          <td>{{ tx.quantity_change }}</td>
          <td>{{ tx.user_id }}</td>
          <td>{{ tx.transaction_date }}</td>
          <td>{{ tx.notes }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="p-2">No transactions found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="mt-3">
    {% include "components/pagination.html" with page_obj=page_obj base_url="" extra_query=query_string %}
  </div>
{% endblock %}

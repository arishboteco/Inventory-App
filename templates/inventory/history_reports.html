{% extends "_base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto p-4">
  <h1 class="text-2xl font-semibold mb-4">History Reports</h1>
    <form method="get" class="flex flex-wrap gap-2 mb-4">
      <select name="item" class="form-control">
        <option value="">All Items</option>
      {% for it in items %}
      <option value="{{ it.item_id }}" {% if item|default:'' == it.item_id|stringformat:"s" %}selected{% endif %}>{{ it.name }}</option>
      {% endfor %}
      </select>
      <select name="type" class="form-control">
      <option value="">All Types</option>
      {% for t in transaction_types %}
      <option value="{{ t }}" {% if type == t %}selected{% endif %}>{{ t }}</option>
      {% endfor %}
      </select>
      <select name="user" class="form-control">
      <option value="">All Users</option>
      {% for u in users %}
      <option value="{{ u }}" {% if user == u %}selected{% endif %}>{{ u }}</option>
      {% endfor %}
      </select>
      <input type="date" name="start_date" value="{{ start_date }}" class="form-control" />
      <input type="date" name="end_date" value="{{ end_date }}" class="form-control" />
      <input type="hidden" name="sort" value="{{ sort|default:'date' }}" />
      <input type="hidden" name="direction" value="{{ direction|default:'desc' }}" />
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Filter</button>
      <a href="?{% if query_string %}{{ query_string }}&{% endif %}export=csv" class="px-4 py-2 border rounded">Export CSV</a>
    </form>
    <div class="overflow-x-auto">
      <table class="table">
        <thead>
          <tr>
            <th>
              <a href="?{% if sort_query %}{{ sort_query }}&{% endif %}sort=id&direction={% if sort == 'id' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                ID{% if sort == 'id' %}{% if direction == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>
              <a href="?{% if sort_query %}{{ sort_query }}&{% endif %}sort=item&direction={% if sort == 'item' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                Item{% if sort == 'item' %}{% if direction == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>
              <a href="?{% if sort_query %}{{ sort_query }}&{% endif %}sort=type&direction={% if sort == 'type' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                Type{% if sort == 'type' %}{% if direction == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>
              <a href="?{% if sort_query %}{{ sort_query }}&{% endif %}sort=qty&direction={% if sort == 'qty' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                Qty{% if sort == 'qty' %}{% if direction == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>
              <a href="?{% if sort_query %}{{ sort_query }}&{% endif %}sort=user&direction={% if sort == 'user' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                User{% if sort == 'user' %}{% if direction == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>
              <a href="?{% if sort_query %}{{ sort_query }}&{% endif %}sort=date&direction={% if sort == 'date' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                Date{% if sort == 'date' %}{% if direction == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>Notes</th>
          </tr>
          </thead>
        <tbody>
          {% for row in page_obj %}
          <tr>
            <td>{{ row.transaction_id }}</td>
            <td>{{ row.item.name }}</td>
            <td>{{ row.transaction_type }}</td>
            <td>{{ row.quantity_change }}</td>
            <td>{{ row.user_id }}</td>
            <td>{{ row.transaction_date }}</td>
            <td>{{ row.notes }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="p-2">No transactions found.</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="p-2 font-semibold text-right">Total</td>
            <td class="p-2 font-semibold">{{ total_quantity }}</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  <div class="flex items-center gap-3 mt-3">
    {% if page_obj.has_previous %}
    <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}" class="px-3 py-1 border rounded">Prev</a>
    {% endif %}
    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
    <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}" class="px-3 py-1 border rounded">Next</a>
    {% endif %}
  </div>
</div>
{% endblock %}

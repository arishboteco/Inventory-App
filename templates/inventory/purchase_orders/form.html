{% extends "_base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto p-4">
  <h1 class="text-2xl font-semibold mb-4">{% if is_edit %}Edit{% else %}New{% endif %} Purchase Order</h1>
  <form method="post" class="space-y-4" id="po-form">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <ul class="text-red-600 list-disc pl-5">
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    {% for field in form %}
      {% include "components/form_field.html" with field=field %}
    {% endfor %}
    <datalist id="supplier-options"></datalist>
    <div id="items-formset">
      {{ formset.management_form }}
      {% if formset.non_form_errors %}
        <ul class="text-red-600 list-disc pl-5">
          {% for error in formset.non_form_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      {% endif %}
      {% for f in formset %}
      <div class="border p-2 item-form">
        {% if f.non_field_errors %}
          <ul class="text-red-600 list-disc pl-5">
            {% for error in f.non_field_errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
        {% endif %}
        {% for field in f %}
          {% include "components/form_field.html" with field=field %}
        {% endfor %}
      </div>
      {% endfor %}
    </div>
    <datalist id="item-options"></datalist>
    <div class="flex space-x-2">
      <button type="button" id="add-item" class="btn-secondary">Add Item</button>
      <button type="submit" class="btn-primary">Save</button>
    </div>
  </form>
  <template id="item-empty-form">
    <div class="border p-2 item-form">
      {% for field in formset.empty_form %}
        {% include "components/form_field.html" with field=field %}
      {% endfor %}
    </div>
  </template>
  <script>
    (function () {
      const formsetPrefix = "{{ formset.prefix }}";
      const addBtn = document.getElementById("add-item");
      const formsetDiv = document.getElementById("items-formset");
      const totalFormsInput = document.getElementById(`id_${formsetPrefix}-TOTAL_FORMS`);
      const emptyForm = document.getElementById("item-empty-form").content;

      addBtn.addEventListener("click", function (e) {
        e.preventDefault();
        const formCount = parseInt(totalFormsInput.value);
        const newForm = emptyForm.cloneNode(true);
        newForm.querySelectorAll("input, select, textarea").forEach(function (el) {
          const name = el.getAttribute("name").replace("__prefix__", formCount);
          const id = `id_${name}`;
          el.setAttribute("name", name);
          el.setAttribute("id", id);
          if (el.type !== "hidden") {
            el.value = "";
          }
        });
        formsetDiv.appendChild(newForm);
        totalFormsInput.value = formCount + 1;
      });

      document.getElementById("po-form").addEventListener("submit", function (e) {
        if (!this.checkValidity()) {
          e.preventDefault();
          this.reportValidity();
        }
      });
    })();
  </script>
</div>
{% endblock %}

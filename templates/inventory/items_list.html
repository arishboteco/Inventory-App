{% extends "_base.html" %}
{% block title %}Items â€“ Inventory App{% endblock %}
{% block content %}
  <h1 class="text-h1 mb-4">Items</h1>
  <div class="mb-4 flex justify-end gap-2">
    <a href="{% url 'item_create' %}" class="btn-primary px-4 py-2 rounded">New Item</a>
    <a href="{% url 'items_bulk_upload' %}" class="btn-secondary px-4 py-2 rounded">Bulk Upload</a>
  </div>
  {% url 'items_table' as items_table_url %}
  {% include "components/filter_bar.html" with search_placeholder="Search items..." hx_get=items_table_url hx_target="#items_table" hx_indicator="#htmx-spinner" filters=filters export_url=export_url sort=sort direction=direction %}
  {{ categories_map|json_script:"categories-data" }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const categories = JSON.parse(
        document.getElementById('categories-data').textContent
      );
      const categoryInput = document.getElementById('filter-category');
      const subInput = document.getElementById('filter-subcategory');
      const subDatalist = document.getElementById('item-subcategory');

      function refreshSubcategories(selected) {
        const cat = categoryInput.value;
        const options = categories[cat] || [];
        subDatalist.innerHTML = '<option value="" label="All"></option>';
        options.forEach(function (opt) {
          const o = document.createElement('option');
          o.value = opt.name;
          subDatalist.appendChild(o);
        });
        if (
          selected &&
          options.some(function (o) {
            return o.name === selected;
          })
        ) {
          subInput.value = selected;
        } else {
          subInput.value = '';
        }
      }

      const initialSub = subInput.value;
      refreshSubcategories(initialSub);
      categoryInput.addEventListener('change', function () {
        refreshSubcategories();
      });
    });
  </script>
  <div id="items_table"
       hx-get="{% url 'items_table' %}"
       hx-trigger="load"
       hx-include="#filters"
       hx-indicator="#htmx-spinner">
    {{ items_table|safe }}
  </div>
{% endblock %}

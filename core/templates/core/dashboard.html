{% extends "_base.html" %}
{% block content %}
<h1 class="text-h1">Dashboard</h1>

<div
  id="kpi-cards"
  hx-get="{% url 'dashboard-kpis' %}"
  hx-trigger="load"
  hx-target="#kpi-cards"
  hx-swap="outerHTML"
>
  Loading KPI metricsâ€¦
</div>

<div class="flex gap-4">
  {% if perms.inventory.add_purchaseorder %}
    <a href="{% url 'purchase_order_create' %}" class="btn-primary px-4 py-2 rounded">New PO</a>
  {% endif %}
  <a href="{% url 'grn_list' %}" class="btn-secondary px-4 py-2 rounded">Record Receipt</a>
</div>

<form id="dashboard-filters" class="flex flex-wrap gap-2 my-4 items-end">
  <div>
    <label for="item" class="block">Item</label>
    <select id="item" name="item" class="border p-1">
      <option value="">All</option>
      {% for item in items %}
        <option value="{{ item.pk }}">{{ item.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="supplier" class="block">Supplier</label>
    <select id="supplier" name="supplier" class="border p-1">
      <option value="">All</option>
      {% for supplier in suppliers %}
        <option value="{{ supplier.pk }}">{{ supplier.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="start" class="block">Start</label>
    <input type="date" id="start" name="start" class="border p-1" />
  </div>
  <div>
    <label for="end" class="block">End</label>
    <input type="date" id="end" name="end" class="border p-1" />
  </div>
  <button type="button" id="apply-filters" class="btn-primary px-4 py-2 rounded">Apply</button>
</form>

<div>
  <canvas id="stock-trend-chart" class="w-full h-64"></canvas>
  <script>
    const ctx = document.getElementById('stock-trend-chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ trend_labels|safe }},
        datasets: [{
          label: 'Stock Trend',
          data: {{ trend_values|safe }},
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.2)',
          tension: 0.4,
        }]
      },
      options: {responsive: true, maintainAspectRatio: false}
    });

    async function fetchTrend() {
      const form = document.getElementById('dashboard-filters');
      const params = new URLSearchParams(new FormData(form));
      const resp = await fetch('{% url "ajax-dashboard-data" %}?'+params.toString());
      const data = await resp.json();
      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.values;
      chart.update();
    }

    document.getElementById('apply-filters').addEventListener('click', fetchTrend);
  </script>
</div>

<h2 class="text-h2 mb-2">Low Stock Items</h2>
<table class="min-w-full text-left border rounded">
  <thead class="bg-gray-50">
    <tr>
      <th class="px-4 py-2">Item Name</th>
      <th class="px-4 py-2">UoM</th>
      <th class="px-4 py-2">Current Stock</th>
      <th class="px-4 py-2">Reorder At</th>
    </tr>
  </thead>
  <tbody>
    {% for item in low_stock %}
      <tr class="border-t">
        <td class="px-4 py-2">{{ item.name }}</td>
        <td class="px-4 py-2">{{ item.uom|default:item.unit }}</td>
        <td class="px-4 py-2">{{ item.current_stock }}</td>
        <td class="px-4 py-2">{{ item.reorder_point }}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="4" class="px-4 py-2">No low stock items.</td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

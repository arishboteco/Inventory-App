{% extends "_base.html" %}
{% load static %}
{% block content %}
<div class="max-w-3xl mx-auto p-4">
  <h1 class="text-2xl font-semibold mb-4">New Indent</h1>
  <form method="post" id="indent-form">
    {% csrf_token %}
    {% if form.non_field_errors %}
    <ul class="text-red-600 list-disc pl-5">
      {% for error in form.non_field_errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
    {% endif %}
    <div class="mb-4 space-y-4">
      {% for field in form %}
      <div>
        {{ field.label_tag }}
        {% if field.field.widget.input_type == "checkbox" %}
        {{ field.as_widget(attrs={'class': 'rounded border-gray-300'}) }}
        {% else %}
        {{ field.as_widget(attrs={'class': 'block w-full rounded border-gray-300 p-2'}) }}
        {% endif %}
        {% if field.errors %}
        <ul class="text-red-600 list-disc pl-5">
          {% for error in field.errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {{ formset.management_form }}
    {% if formset.non_form_errors %}
    <ul class="text-red-600 list-disc pl-5">
      {% for error in formset.non_form_errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
    {% endif %}
    <table class="min-w-full border divide-y" id="items-table">
      <thead>
        <tr class="bg-gray-50">
          <th class="px-3 py-2 text-left">Item</th>
          <th class="px-3 py-2 text-left">Qty</th>
          <th class="px-3 py-2 text-left">Notes</th>
          <th class="px-3 py-2"></th>
        </tr>
      </thead>
      <tbody>
      {% for item_form in formset %}
        <tr class="form-row">
          <td class="px-3 py-2">
            {{ item_form.item.as_widget(attrs={'class': 'block w-full rounded border-gray-300 p-2'}) }}
            {% if item_form.item.errors %}
            <ul class="text-red-600 list-disc pl-5">
              {% for error in item_form.item.errors %}<li>{{ error }}</li>{% endfor %}
            </ul>
            {% endif %}
          </td>
          <td class="px-3 py-2">
            {{ item_form.requested_qty.as_widget(attrs={'class': 'block w-full rounded border-gray-300 p-2'}) }}
            {% if item_form.requested_qty.errors %}
            <ul class="text-red-600 list-disc pl-5">
              {% for error in item_form.requested_qty.errors %}<li>{{ error }}</li>{% endfor %}
            </ul>
            {% endif %}
          </td>
          <td class="px-3 py-2">
            {{ item_form.notes.as_widget(attrs={'class': 'block w-full rounded border-gray-300 p-2'}) }}
            {% if item_form.notes.errors %}
            <ul class="text-red-600 list-disc pl-5">
              {% for error in item_form.notes.errors %}<li>{{ error }}</li>{% endfor %}
            </ul>
            {% endif %}
          </td>
          <td class="px-3 py-2"><button type="button" class="remove-row text-red-600">Remove</button></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    <div class="mt-2">
      <button type="button" id="add-row" class="px-4 py-2 border rounded">Add Item</button>
    </div>
    <div class="mt-4">
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Submit</button>
    </div>
  </form>
</div>
<script>
(function() {
  const addBtn = document.getElementById('add-row');
  const table = document.getElementById('items-table').getElementsByTagName('tbody')[0];
  const totalForms = document.getElementById('id_items-TOTAL_FORMS');
  addBtn.addEventListener('click', function() {
    const newIndex = parseInt(totalForms.value, 10);
    const emptyRow = table.querySelector('.form-row').cloneNode(true);
    emptyRow.querySelectorAll('input,select,textarea').forEach(function(el) {
      const name = el.getAttribute('name').replace(/-\d+-/, '-' + newIndex + '-');
      const id = 'id_' + name;
      el.setAttribute('name', name);
      el.setAttribute('id', id);
      if (el.type !== 'hidden') { el.value = ''; }
    });
    table.appendChild(emptyRow);
    totalForms.value = newIndex + 1;
  });
  table.addEventListener('click', function(e){
    if(e.target.classList.contains('remove-row')){
      const rows = table.querySelectorAll('.form-row');
      if(rows.length > 1){
        e.target.closest('.form-row').remove();
        totalForms.value = rows.length - 1;
      }
    }
  });
})();
</script>
{% endblock %}

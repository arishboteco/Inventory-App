{% extends "_base.html" %}
{% block content %}
<h1 class="text-h1 mb-4">Dashboard</h1>

<div
  id="kpi-cards"
  class="mb-6"
  hx-get="{% url 'dashboard-kpis' %}"
  hx-trigger="load"
  hx-target="#kpi-cards"
  hx-swap="outerHTML"
>
  Loading KPIsâ€¦
</div>

<div class="flex gap-4">
  {% if perms.inventory.add_purchaseorder %}
    <a href="{% url 'purchase_order_create' %}" class="btn-primary px-4 py-2 rounded">New PO</a>
  {% endif %}
  <a href="{% url 'grn_list' %}" class="btn-secondary px-4 py-2 rounded">Record Receipt</a>
</div>

<form id="dashboard-filters" class="flex flex-wrap gap-2 my-4 items-end">
  <div>
    <label for="item" class="block">Item</label>
    <select id="item" name="item" class="border p-1">
      <option value="">All</option>
      {% for item in items %}
        <option value="{{ item.pk }}">{{ item.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="supplier" class="block">Supplier</label>
    <select id="supplier" name="supplier" class="border p-1">
      <option value="">All</option>
      {% for supplier in suppliers %}
        <option value="{{ supplier.pk }}">{{ supplier.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="start" class="block">Start</label>
    <input type="date" id="start" name="start" class="border p-1" />
  </div>
  <div>
    <label for="end" class="block">End</label>
    <input type="date" id="end" name="end" class="border p-1" />
  </div>
  <button type="button" id="apply-filters" class="btn-primary px-4 py-2 rounded">Apply</button>
</form>

<div>
  <canvas id="stock-trend-chart" class="w-full h-64"></canvas>
  <script>
    const ctx = document.getElementById('stock-trend-chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ trend_labels|safe }},
        datasets: [{
          label: 'Stock Trend',
          data: {{ trend_values|safe }},
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.2)',
          tension: 0.4,
        }]
      },
      options: {responsive: true, maintainAspectRatio: false}
    });

    async function fetchTrend() {
      const form = document.getElementById('dashboard-filters');
      const params = new URLSearchParams(new FormData(form));
      const resp = await fetch('{% url "ajax-dashboard-data" %}?'+params.toString());
      const data = await resp.json();
      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.values;
      chart.update();
    }

    document.getElementById('apply-filters').addEventListener('click', fetchTrend);
  </script>
</div>

<h2 class="text-h2 mb-2">Low Stock Items</h2>
<ul class="space-y-2">
  {% for item in low_stock %}
    <li class="flex items-center justify-between p-4 rounded border">
      <div class="flex items-center gap-2">
        <svg aria-hidden="true" class="w-5 h-5 text-danger" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"/></svg>
        <span>{{ item.name }}</span>
      </div>
      <span class="badge-warning">{{ item.current_stock }} / {{ item.reorder_point }}</span>
    </li>
  {% empty %}
    <li class="p-4 border rounded">No low stock items.</li>
  {% endfor %}
</ul>
{% endblock %}

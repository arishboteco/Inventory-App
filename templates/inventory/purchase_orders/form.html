{% extends "_base.html" %}
{% block title %}{% if is_edit %}Edit{% else %}New{% endif %} Purchase Order â€“ Inventory App{% endblock %}
{% block content %}
<div class="w-full max-w-4xl max-md:max-w-xl max-sm:max-w-md mx-auto max-h-screen overflow-y-auto p-8 max-sm:p-4">
  <h1 class="text-2xl font-semibold mb-4">{% if is_edit %}Edit{% else %}New{% endif %} Purchase Order</h1>
  {% if form %}
  <form method="post" id="po-form" class="grid grid-cols-1 gap-4">
    {% csrf_token %}
    {% if form.non_field_errors %}
    <ul class="text-red-600 list-disc pl-5">
      {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
    </ul>
    {% endif %}
    <div class="grid gap-4 grid-cols-2 max-sm:grid-cols-1">
      {% for field in form %}
        {% include "components/form_field.html" with field=field %}
      {% endfor %}
    </div>
    <datalist id="supplier-options"></datalist>
    <div id="items-formset">
      {{ formset.management_form }}
      {% if formset.non_form_errors %}
        <ul class="text-red-600 list-disc pl-5">
          {% for error in formset.non_form_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      {% endif %}
      {% for f in formset %}
      <div class="border p-2 item-form">
        {% if f.non_field_errors %}
          <ul class="text-red-600 list-disc pl-5">
            {% for error in f.non_field_errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
        {% endif %}
        {% for field in f %}
          {% include "components/form_field.html" with field=field %}
        {% endfor %}
      </div>
      {% endfor %}
    </div>
    <datalist id="item-options"></datalist>
    <div>
      <button type="button" id="add-item" class="btn-secondary">Add Item</button>
    </div>
    <div class="flex gap-2">
      <button type="submit" class="btn-primary">Save</button>
      <a href="{% url 'purchase_orders_list' %}" class="btn-outline">Cancel</a>
    </div>
  </form>
  <template id="item-empty-form">
    <div class="border p-2 item-form">
      {% for field in formset.empty_form %}
        {% include "components/form_field.html" with field=field %}
      {% endfor %}
    </div>
  </template>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      initFormset({
        formsetPrefix: '{{ formset.prefix }}',
        addButtonId: 'add-item',
        formContainer: '#items-formset',
        formClass: 'item-form',
        templateId: 'item-empty-form'
      });
      document.getElementById('po-form').addEventListener('submit', function (e) {
        if (!this.checkValidity()) {
          e.preventDefault();
          this.reportValidity();
        }
      });
    });
  </script>
  {% else %}
    <p>Unable to load form.</p>
  {% endif %}
</div>
{% endblock %}

